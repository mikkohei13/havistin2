{% extends "base.html" %}

    {% block head %}
    <title>{{ html["taxon_data"]["display_name"]|safe }}, vuodenkierto - Havistin (biomi.org)</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
    crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" crossorigin=""></script>
    {% endblock %}

    {% block breadcrumb %}
    <a href="../../../">Lintuatlas</a> &raquo; Dev
    {% endblock %}

    {% block body %} 

    <h1>{{ html["taxon_data"]["display_name"]|safe }}</h1>
    
    <p id="counter">1. tammikuuta</p>
    
    <div id="largemap" class="narrowmap"></div>

    <script>
        const events = [
        // Add your events here in the following format:
        // { day: 1, lat: 40.7128, lng: -74.0060 }
            {{ html["observations_string"]|safe }}
        ];

        const map = L.map('largemap').setView([64, 24], 5);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        const millisecondsPerDay = 100;
        const animationDuration = 20; // The number of days an event stays visible
        const startDate = new Date(2022, 0, 1); // January 1st

        const counter = document.getElementById('counter');

        function updateCounter(date) {
            const monthNames = [
                'tammikuuta', 'helmikuuta', 'maaliskuuta', 'huhtikuuta', 'toukokuuta', 'kesäkuuta', 'heinäkuuta', 'elokuuta', 'syyskuuta', 'lokakuuta', 'marraskuuta', 'joulukuuta'
            ];
            
            const day = date.getDate();
            const month = monthNames[date.getMonth()];
            counter.innerText = `${day}. ${month}`;
        }

        function displayEvent(event) {
            const marker = L.circleMarker([event.lat, event.lng], {
                color: 'transparent',
                fillColor: '#f03',
                fillOpacity: 1,
                radius: 5
            }).addTo(map);

            const fadeDuration = animationDuration * millisecondsPerDay;
            const fadeInterval = 100; // Adjust this value for smoother or quicker fading
            const fadeStep = (fadeInterval / fadeDuration) * 1; // Calculate the opacity reduction per step

            let currentOpacity = 1;
            const fadeMarker = setInterval(() => {
                currentOpacity -= fadeStep;
                if (currentOpacity <= 0) {
                map.removeLayer(marker);
                clearInterval(fadeMarker);
                } else {
                marker.setStyle({ fillOpacity: currentOpacity });
                }
            }, fadeInterval);
        }

        /*
        function displayEvent(event) {
            const marker = L.circleMarker([event.lat, event.lng], {
                color: 'red',
                fillColor: '#f03',
                fillOpacity: 0.5,
                radius: 5
            }).addTo(map);

            setTimeout(() => {
                map.removeLayer(marker);
            }, animationDuration * millisecondsPerDay);
        }
        */

        function animateEvents() {
            const currentDate = new Date(startDate);
            let dayCounter = 1;
            updateCounter(currentDate);

            const animationInterval = setInterval(() => {
                events.forEach(event => {
                    if (event.day === dayCounter) {
                        displayEvent(event);
                    }
                });

                currentDate.setDate(currentDate.getDate() + 1);
                dayCounter++;
                updateCounter(currentDate);

                if (dayCounter > 365) {
                    clearInterval(animationInterval);
                }
            }, millisecondsPerDay);
        }

        animateEvents();


    </script> 

    {% endblock %}
